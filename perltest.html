

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Perl Test &mdash; Monty Lacuna 0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="static/monty_foot.ico"/>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Monty Lacuna 0.1 documentation" href="index.html"/>
        <link rel="next" title="bc" href="bc.html"/>
        <link rel="prev" title="Send Excavs Tests" href="tests/send_excavs.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Monty Lacuna</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started_running.html">Getting Started Running Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#overview-of-steps">Overview of Steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#install-python-3">Install Python 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#install-montylacuna">Install MontyLacuna</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#install-pip-and-prerequisite-libraries">Install pip and Prerequisite Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#create-a-config-file">Create A Config File</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_running.html#ready-to-test">Ready to Test</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scripts/index.html">MontyLacuna Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scripts/index.html#starter-scripts">Starter Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts/index.html#regular-scripts">Regular Scripts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="config_file.html">Config File</a><ul>
<li class="toctree-l2"><a class="reference internal" href="config_file.html#setting-descriptions">Setting Descriptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="config_file.html#default-values">Default Values</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_writing.html">Getting Started Writing Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#tell-your-script-where-montylacuna-lives">Tell Your Script Where MontyLacuna Lives</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#connect-a-client">Connect a client</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#logging-and-caching">Logging and Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#debugging-requests">Debugging Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#method-calling">Method Calling</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#test-scripts">Test Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#adding-unit-tests">Adding Unit Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started_writing.html#example-snippets">Example Snippets</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tle_modules/index.html">TLE Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/alliance.html">Alliance</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/body.html">Body</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/building.html">Building</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/captcha.html">Captcha</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/empire.html">Empire</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/inbox.html">Inbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/map.html">Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="tle_modules/stats.html">Stats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tests/index.html">Unit Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tests/index.html#existing-tests">Existing tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="tests/index.html#running-all-tests">Running all tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="tests/index.html#creating-script-tests">Creating script tests</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Perl Test</a></li>
<li class="toctree-l1"><a class="reference internal" href="bc.html">bc</a></li>
<li class="toctree-l1"><a class="reference internal" href="caching.html">caching</a><ul>
<li class="toctree-l2"><a class="reference internal" href="caching.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html#synopsis">Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html#script-conventions">Script Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html#module-lacuna.clients">Module Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="clients.html">clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glyph.html">glyph</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">logging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="logging.html#log-levels">Log Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#request-log">Request Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#user-log">User Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#module-log">Module Log</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="my_validate_email.html">my_validate_email</a></li>
<li class="toctree-l1"><a class="reference internal" href="plan.html">plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="recycling.html">recycling</a></li>
<li class="toctree-l1"><a class="reference internal" href="resource.html">resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="ship.html">ship</a></li>
<li class="toctree-l1"><a class="reference internal" href="spy.html">spy</a></li>
<li class="toctree-l1"><a class="reference internal" href="trading.html">trading</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">types</a><ul>
<li class="toctree-l2"><a class="reference internal" href="types.html#ship-translations">Ship Translations</a></li>
<li class="toctree-l2"><a class="reference internal" href="types.html#ore-translations">Ore Translations</a></li>
<li class="toctree-l2"><a class="reference internal" href="types.html#spy-assignment-translations">Spy Assignment Translations</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Monty Lacuna</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Perl Test</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="sources/perltest.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="perl-test">
<h1>Perl Test<a class="headerlink" href="#perl-test" title="Permalink to this headline">Â¶</a></h1>
<p>I&#8217;m wanting to keep this class framework-agnostic, so you&#8217;re not stuck using
Catalyst if you don&#8217;t want to.</p>
<p>However, you&#8217;re often going to want to, and this method saves some typing if
that&#8217;s the case.</p>
<p>Tell your controller&#8217;s begin method when to do JSON RPC 2.0 stuff.  That&#8217;s
often going to be whenever you&#8217;re hit via POST, but it&#8217;s up to your controller
to decide that:</p>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">use</span> <span class="nn">JSON::</span><span class="n">RPC20</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">begin</span> <span class="p">:Private {</span>
 <span class="k">my</span> <span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$c</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
 <span class="k">if</span><span class="p">(</span> <span class="nv">$c</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">method</span> <span class="ow">eq</span> <span class="s">&#39;POST&#39;</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nn">JSON::</span><span class="n">RPC20</span><span class="o">-&gt;</span><span class="n">run_for_catalyst</span><span class="p">(</span><span class="nv">$c</span><span class="p">,</span> <span class="nv">$self</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That performs all the parsing and routing.  All you have to do is ensure that
any methods that the user might request exist in your controller as private
methods that accept JSON::RPC20 and JSON::RPC20::Request objects after the
usual $self and $c, and which call set_response() on that JSON::RPC20 object:</p>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">sub </span><span class="nf">some_user_callable_method</span> <span class="p">:Private {</span>
   <span class="k">my</span><span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$jsonrpc</span><span class="p">,</span> <span class="nv">$req</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$rslt</span> <span class="o">=</span> <span class="p">{</span><span class="n">username</span> <span class="o">=&gt;</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">password</span> <span class="o">=&gt;</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
   <span class="nv">$jsonrpc</span><span class="o">-&gt;</span><span class="n">set_response</span><span class="p">(</span> <span class="nv">$req</span><span class="p">,</span> <span class="nv">$rslt</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">some_other_user_callable_method</span> <span class="p">:Private {</span>
   <span class="k">my</span><span class="p">(</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$c</span><span class="p">,</span> <span class="nv">$jsonrpc</span><span class="p">,</span> <span class="nv">$req</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
   <span class="k">my</span> <span class="nv">$rslt</span> <span class="o">=</span> <span class="p">{</span><span class="n">email</span> <span class="o">=&gt;</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">age</span> <span class="o">=&gt;</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">params</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
   <span class="nv">$jsonrpc</span><span class="o">-&gt;</span><span class="n">set_response</span><span class="p">(</span> <span class="nv">$req</span><span class="p">,</span> <span class="nv">$rslt</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">YA_ucm</span> <span class="p">:Private {</span> <span class="o">...</span> <span class="p">}</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The request_string attribute is required, so we normally need to be called as:</dt>
<dd>my $trans = JSON::RPC20-&gt;new({ request_string =&gt; $string });</dd>
<dt>But we want to allow the user to save some typing, so we&#8217;ll also allow:</dt>
<dd>my $trans = JSON::RPC20-&gt;new( $string );</dd>
</dl>
<p>And since we&#8217;ll often be used from a Catalyst app, and Catalyst may well be
returning a <a class="reference external" href="File::Temp">File::Temp</a> object in $c-&gt;req-&gt;body, we&#8217;ll also allow:</p>
<blockquote>
<div>my $trans = JSON::RPC20-&gt;new( &lt;File::Temp object&gt; );</div></blockquote>
<p>Checks each individual request hashref (there will often be only one) for
validity.</p>
<p>Generates request and response objects objects from the request hashref.  If
the request was invalid, the response object will have its error attribute
set.</p>
<p>Returns all request objects in the current transaction as a list, sorted
ascending by their IDs.</p>
<p>Sets the result for a given request.</p>
<p>Your code calls the method indicated by $request-&gt;method, which needs to
return some result.  Pass both the request and the produced response to
set_response.</p>
<dl class="docutils">
<dt>$rslt can be EITHER:</dt>
<dd><ul class="first last simple">
<li>The actual result returned by the requested method</li>
<li>An JSON::RPC20::Error object representing whatever error was
encountered by the requested method.</li>
</ul>
</dd>
</dl>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$meth</span> <span class="o">=</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$rslt</span> <span class="o">=</span> <span class="nv">$some_class</span><span class="o">-&gt;</span><span class="nv">$meth</span><span class="p">();</span>
<span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">set_response</span><span class="p">(</span> <span class="nv">$req</span><span class="p">,</span> <span class="nv">$rslt</span> <span class="p">);</span>
</pre></div>
</div>
<p>in $some_class:</p>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">sub </span><span class="nf">the_example_method_being_called</span> <span class="p">{</span>
 <span class="k">if</span><span class="p">(</span> <span class="n">something_went_wrong</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="nn">JSON::RPC20::</span><span class="n">Error</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
  <span class="nv">$err</span><span class="o">-&gt;</span><span class="n">invalid_params</span><span class="p">();</span>             <span class="c1"># or whatever</span>
  <span class="k">return</span> <span class="nv">$err</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="k">my</span> <span class="nv">$hr</span> <span class="o">=</span> <span class="p">{</span> <span class="n">the_answer_is</span> <span class="o">=&gt;</span> <span class="mi">42</span> <span class="p">};</span>
 <span class="k">return</span> <span class="nv">$hr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Returns $self-&gt;responses as a JSON-encoded string to be passed back to the
user.</p>
<p>Before encoding responses, set_response() must first be called for each
request.</p>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nn">JSON::</span><span class="n">RPC20</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span> <span class="n">request_string</span> <span class="o">=&gt;</span> <span class="nv">$json_string</span> <span class="p">});</span>
</pre></div>
</div>
<p>or, to save a little typing...</p>
<div class="highlight-perl"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$txn</span> <span class="o">=</span> <span class="nn">JSON::</span><span class="n">RPC20</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$json_string</span> <span class="p">);</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$req</span><span class="p">(</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
    <span class="o">-</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">code</span> <span class="n">in</span> <span class="nv">$req</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">a</span> <span class="n">result</span> <span class="p">(</span><span class="n">eg</span> <span class="n">in</span> <span class="nv">$rslt</span><span class="p">)</span><span class="o">.</span>
    <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">set_response</span><span class="p">(</span> <span class="nv">$req</span><span class="p">,</span> <span class="nv">$rslt</span> <span class="p">);</span>
<span class="p">}</span>
<span class="n">send_to_user</span><span class="p">(</span> <span class="nv">$txn</span><span class="o">-&gt;</span><span class="n">encode_responses</span><span class="p">()</span> <span class="p">);</span>
</pre></div>
</div>
<p>encode_responses() returns the correct response even if the $json_string
handed in by the user was an invalid JSON RPC 2.0 request, or even if it&#8217;s
unparseable json.</p>
<p>However, in those two cases, $self-&gt;success will be set to 0 so you can
manually cope with it if you need to.</p>
<p>AUTHENTICATION
Some JSON requests will require authentication.  This will often follow the flow:</p>
<blockquote>
<div><ul class="simple">
<li>user sends JSON request to /json_login including the params &#8216;username&#8217; and
&#8216;password&#8217;</li>
<li>app checks those creds.  If correct, app hands back a session ID.</li>
<li>user then includes that session ID as a param in any future requests to
modules/methods that require auth.  Those modules/methods are responsible
for checking that session ID.</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>In the case of a batch of requests, we have two options:</dt>
<dd><ul class="first last simple">
<li>Authenticate each request in the batch separately.  Each request requires a
session ID (though all may be the same value), and each request&#8217;s session
is checked individually.</li>
</ul>
</dd>
</dl>
<ul class="simple">
<li>Authenticate the batch once, and assume that each request within the batch
is using the same authentication.  Mark the entire batch as authenticated,
and don&#8217;t re-auth each individual request.</li>
</ul>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="bc.html" class="btn btn-neutral float-right" title="bc"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tests/send_excavs.html" class="btn btn-neutral" title="Send Excavs Tests"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 - 2015, Jonathan Barton.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="static/jquery.js"></script>
      <script type="text/javascript" src="static/underscore.js"></script>
      <script type="text/javascript" src="static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>